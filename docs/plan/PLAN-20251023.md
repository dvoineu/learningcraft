# План: устранение бага входа для существующих профилей

## Контекст
- **Репозиторий**: `web-learningcraft`
- **Проблема**: при попытке войти под ранее созданным профилем интерфейс не реагирует — отсутствует перенаправление/отображение авторизации.
- **Система аутентификации**: Supabase, клиентские сервисы в `src/modules/auth/`.

## Цели
- **Воспроизвести**: подтвердить наличие бага на действующей учётной записи.
- **Диагностировать**: локализовать в коде причину отсутствия реакции (напроверить API, состояние, маршрутизацию).
- **Исправить**: внести правку, гарантирующую успешный вход и корректное обновление состояния UI.
- **Проверить**: убедиться, что аутентификация и редирект работают стабильно.

## Гипотезы
- **[H1]** Ошибка в реактивном состоянии хука `useAuth` (не обновляется `user`).
- **[H2]** Редирект из `SignInForm` (`router.push`) блокируется из-за асинхронной инициализации Supabase или отсутствия ожидания события `onAuthStateChange`.
- **[H3]** Supabase возвращает сессию, но `getCurrentUser()` или `mapUser()` теряет данные (например, `user.user_metadata`).
- **[H4]** Middleware или `app/[locale]/layout` фильтрует доступ и сбрасывает сессию вновь авторизованным пользователям.

## План действий
1. **Изучить реализацию аутентификации**
   - Просмотреть `src/modules/auth/services/auth-service.ts`, `useAuth.ts`, `SignInForm.tsx`, `middleware.ts`.
   - Проверить, как хранится и читается сессия (Supabase client vs серверные компоненты).
2. **Воспроизвести баг локально**
   - Запустить проект (`npm run dev`).
   - Создать/использовать существующую учётную запись, выполнить вход.
   - Отслеживать network/console, убедиться в отсутствии перехода.
3. **Диагностировать проблему**
   - Проверить ответы `supabase.auth.signInWithPassword`.
   - Изучить обработку результата в `useAuth` и компонентах. Проверить наличие дополнительных проверок в `middleware.ts`.
   - Исключить проблемы с локалями/маршрутизацией (`router.push("/{locale}")`).
4. **Разработать и реализовать исправление**
   - Внести точечные изменения (например, корректное обновление состояния, ожидание router или session storage).
   - Обновить связанные тесты/типизацию (при необходимости).
5. **Проверить и задокументировать**
   - Повторно выполнить сценарий входа.
   - Описать результат и дополнительные рекомендации.

## Артефакты для проверки
- **Компоненты**: `SignInForm.tsx`, `GoogleSignInButton.tsx`, `UserMenu.tsx`
- **Хуки**: `useAuth.ts`
- **Сервисы**: `auth-service.ts`
- **Middleware**: `src/middleware.ts`
- **Маршруты**: `src/app/[locale]/auth/signin/page.tsx`, `src/app/[locale]/layout.tsx`

## Критерии успешности
- Вход с существующей учётной записью открывает главную страницу без ручного обновления.
- Состояние пользователя (`useAuth().user`) содержит актуальные данные.
- При повторной загрузке страницы сессия сохраняется.
- Отсутствуют ошибки в консоли и HTTP-запросах Supabase.
